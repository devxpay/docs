bottomparticipants
actor "Buyer" as Client
participant "Merchant\nFrontend\n" as MerchF
participant "Merchant\nBackend\n" as Merch
participant "RBK.Money\n" as RBK #42E299
entryspacing 0.9
Client->MerchF:1) Регистрация в интерфейсе
activate MerchF
MerchF->Merch: 2) Создание пользователя\n(customerData)
activate Merch
Merch->RBK:3) Создание пользователя: \n<link:https://developer.rbk.money/api/#operation/createCustomer>createCustomer</link>\n(сustomerData, API Key)
activate RBK
RBK-->Merch:201 \n(customerID, сustomerData, customerAccessToken)
deactivate RBK
Merch-->MerchF:customerID, сustomerData, customerAccessToken
deactivate Merch
MerchF->Client:4) Сообщение об успехе
deactivate MerchF
Client->MerchF:5) Выбор товаров или услуг\nОформление заказа\nЗапрос на покупку
activate MerchF
MerchF->Merch:6) Оформление заказа\nЗапрос на покупку
activate Merch
Merch->Merch:7) Резерв товара\nФормирование invoiceData 
Merch->RBK:8) Выставление счета на оплату: <link:https://developer.rbk.money/api/#operation/createInvoice>createInvoice</link>\n(invoiceData, API Key)
activate RBK
RBK-->Merch:201 (invoiceData, invoiceAccessToken)
deactivate RBK
Merch-->MerchF:ok (invoiceData, invoiceAccessToken)
deactivate Merch
MerchF->Client:9) Страница оплаты заказа\nс возможностью запомнить \nбанковскую карту
deactivate MerchF
activate Client
Client->MerchF:Ввод данных карты\nСогласие на привязку карты и\nсовершение платежа: clickPayButton\n(cardData)
deactivate Client
activate MerchF
MerchF->RBK:10) Данные баноквской карты\n(cardData,\ninvoiceAccessToken, paymentTool)
activate RBK
aboxright over MerchF,RBK:**Примечание к шагу 10**\nВызов библиотеки Tokenizer.JS,\nкоторая выполняет запрос к backend RBK\nна создание токена платежного средства:\n<link:https://developer.rbk.money/api/#operation/createPaymentResource>createPaymentResource</link>
box left of MerchF:Запрос на создание токена не обязательно \nвыполнять путем вызова Tokenizer.JS: \nего можно отправить \nнапрямую с Merchant Frontend \nили через Merchant Backend
RBK-->MerchF: 201 (paymentToolToken, paymentSession)
deactivate RBK
MerchF->RBK:11) Привязка карты к пользователю: <link:https://developer.rbk.money/api/#operation/createBinding>createBinding</link>\n(customerID, customerAccessToken, paymentToolToken, paymentSession)
activate RBK
RBK-->MerchF: 201 (customerBindingID, paymentToolToken, paymentSession)
deactivate RBK
MerchF->RBK:12) Получение событий, связанных с пользователем:\n<link:https://developer.rbk.money/api/#operation/getCustomerEvents>getCustomerEvents</link>
activate RBK
box left of MerchF:Значение, отличное от \nCustomerBindingStatusChanged говорит \nо том, что с пользователем еще должны \nпроизойти определенные события. \nПример: \nchangeType: CustomerBindingInteractionRequested \nи interactionType: Rediret говорят о необходимости \nподтвердить привязку карты на форме банка
RBK-->MerchF:changeType: CustomerBindingStatusChanged
deactivate RBK
MerchF->RBK:13) Получение статуса пользователя:\n<link:https://developer.rbk.money/api/#operation/getCustomerById>getCustomerById</link>
activate RBK
box left of MerchF:Значение, отличное от ready говорит\nо том, что для данного пользователя\nнельзя совершать платеж \nс привязанной карты (payerType: CustomerPayer).
RBK-->MerchF: status: ready
deactivate RBK
MerchF->RBK:14) Запрос на оплату высталенного счета:\n<link:https://developer.rbk.money/api/#operation/createPayment>createPayment</link>\n(invoiceAccessToken,\npaymentToolToken, paymentSession,\npayerType: CustomerPayer,\ncustomerID)
activate RBK
RBK-->MerchF: 201 (paymentID)
deactivate RBK
MerchF->RBK:15) Получение событий оплаты:\n<link:https://developer.rbk.money/api/#operation/getInvoiceEvents>getInvoiceEvents</link>\n(invoiceAccessToken, invoiceID)
activate RBK
box left of MerchF:Значение, отличное от \nInvoiceStatusChanged говорит\nо том, что с оплатой еще должны \nпроизойти определенные события.\nПример: \nchangeType: PaymentInteractionRequested \nи interactionType: Redirect говорят о \nнеобходимости пройти <link:https://developer.rbk.money/docs/payments/3dsecure/>3DS</link> 
RBK-->MerchF: changeType: InvoiceStatusChanged
deactivate RBK
MerchF->Client:16) Сообщение об успехе 
deactivate MerchF
alt 17) запрос статуса 
MerchF->RBK:Запрос на получение статуса платежа:\n<link:https://developer.rbk.money/api/#operation/getPaymentByID>getPaymentByID</link> (invoiceID, invoiceAccessToken) 
activate RBK
RBK-->MerchF: status
deactivate RBK
box left of MerchF:Запрос статуса можно выполнить\nкак напрямую с Merchant Frontend,\nтак и через Merchant Backend.\nПолучить уведомление также\nможет любой endpoint,\nнезависимо от части сервиса. 
activate MerchF
else 17) получение уведомления
RBK->MerchF: Уведомление об оплате: <link:https://developer.rbk.money/api/#tag/Webhooks>webhook</link>
end
MerchF->Client:18) Success page\nИнформирование об оплате/заказе
deactivate MerchF







  



